{% extends 'base.html' %}

{% block title %}<title>Edit User: {{ object.email }} | Shifter</title>{% endblock %}

{% block content %}
<div class="standard-page-width">
    <div class="py-2">
        <h1 class="title">Edit User</h1>
    </div>
    <div>
        <p class="text-gray-800 border-b-2 border-gray-400 pb-2">Edit user details, reset their password, or delete their account.</p>
    </div>
    <div class="p-2">
        <form class="space-y-1 p2" method="post">
            {% csrf_token %}
            {% if form.non_field_errors %}<div class="error-box">{{ form.non_field_errors }}</div>{% endif %}

            <div class="flex">
                <p class="text-gray-800">{{ form.email.label }}:</p>
                {% if form.email.errors %}<div class="ml-2 error-box grow">{{ form.email.errors }}</div>{% endif %}
            </div>
            <input name="{{ form.email.html_name }}" value="{{ form.email.value }}" class="w-full input-primary" placeholder="your@email.com">

            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 py-2">
                <div class="flex items-center justify-between md:justify-start gap-2">
                    <label for="id_is_staff" class="text-gray-800 flex flex-col">
                        <span>{{ form.is_staff.label }}</span>
                        <span class="text-sm text-gray-600">Can manage users and change site settings.</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input name="{{ form.is_staff.html_name }}" id="id_is_staff" type="checkbox" class="sr-only peer"
                               {% if form.is_staff.value %}checked{% endif %}
                               {% if is_self %}disabled{% endif %}>
                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-200 {% if is_self %}peer-disabled:opacity-50 peer-disabled:cursor-not-allowed{% endif %}"></div>
                    </label>
                    {% if is_self %}<span class="text-gray-500 text-sm">(Cannot change your own admin status)</span>{% endif %}
                </div>

                <div class="flex items-center justify-between md:justify-start gap-2">
                    <label for="id_is_active" class="text-gray-800 flex flex-col">
                        <span>{{ form.is_active.label }}</span>
                        <span class="text-sm text-gray-600">Inactive users cannot log in.</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input name="{{ form.is_active.html_name }}" id="id_is_active" type="checkbox" class="sr-only peer"
                               {% if form.is_active.value %}checked{% endif %}
                               {% if is_self %}disabled{% endif %}>
                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-200 {% if is_self %}peer-disabled:opacity-50 peer-disabled:cursor-not-allowed{% endif %}"></div>
                    </label>
                    
                    {% if is_self %}<span class="text-gray-500 text-sm">(Cannot deactivate yourself)</span>{% endif %}
                    
                </div>
            </div>
            <div class="flex justify-end py-2">
                <input type="submit" value="Save Changes" class="btn-primary">
            </div>
        </form>
    </div>

    <div class="p-2 border-t-2 border-gray-400 mt-4">
        {% if not is_self %}
        <h2 class="text-gray-800 text-2xl font-medium mb-4">Actions</h2>
        <div class="flex gap-2">
            <button type="button" data-modal-target="reset-password-modal" data-modal-toggle="reset-password-modal" class="btn-primary">Reset Password</button>
            <button type="button" data-modal-target="delete-user-modal" data-modal-toggle="delete-user-modal" class="btn-red ml-auto">Delete User</button>
        </div>
        {% else %}
        <h2 class="text-gray-800 text-2xl font-medium mb-4">Change Your Password</h2>
        <a href="{% url 'shifter_auth:settings' %}" class="btn-primary">Go to Settings</a>
        {% endif %}
    </div>

    {% if not is_self %}
    {# Reset Password Modal #}
    <div id="reset-password-modal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-modal md:h-full">
        <div class="bg-gray-400 opacity-50 fixed inset-0 z-40"></div>
        <div class="relative w-full h-full max-w-2xl md:h-auto z-50">
            <div class="relative bg-white rounded-lg shadow">
                <div class="flex items-center justify-center p-4 border-b border-gray-200 rounded-t">
                    <h3 class="text-xl font-semibold text-gray-900">
                        Reset Password?
                    </h3>
                </div>
                <div class="p-6 space-y-6">
                    <p class="text-base leading-relaxed text-gray-600">
                        Are you sure you want to reset the password for <strong>{{ object.email }}</strong>?
                    </p>
                    <p class="text-base leading-relaxed text-gray-600">
                        A new temporary password will be generated and displayed. The user will be required to change it on their next login.
                    </p>
                </div>
                <div class="flex flex-row-reverse p-6 space-x-2 border-t border-gray-200 rounded-b">
                    <form method="post" action="{% url 'shifter_auth:user-reset-password' pk=object.pk %}">
                        {% csrf_token %}
                        <input type="submit" value="Reset Password" class="inline-flex justify-center m-2 text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 font-medium rounded-lg text-sm px-5 py-2.5 text-center cursor-pointer">
                    </form>
                    <button data-modal-toggle="reset-password-modal" type="button" class="inline-flex justify-center m-2 text-gray-900 bg-gray-200 hover:bg-gray-300 focus:ring-4 focus:outline-none focus:ring-primary rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 cursor-pointer">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if not is_self %}
    {# Delete User Modal #}
    <div id="delete-user-modal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-modal md:h-full">
        <div class="bg-gray-400 opacity-50 fixed inset-0 z-40"></div>
        <div class="relative w-full h-full max-w-2xl md:h-auto z-50">
            <div class="relative bg-white rounded-lg shadow">
                <div class="flex items-center justify-center p-4 border-b border-gray-200 rounded-t">
                    <h3 class="text-xl font-semibold text-gray-900">
                        Delete User?
                    </h3>
                </div>
                <div class="p-6 space-y-6">
                    <p class="text-base leading-relaxed text-gray-600">
                        Are you sure you want to delete <strong>{{ object.email }}</strong>?
                    </p>
                    <p class="text-base leading-relaxed text-gray-600">
                        This will permanently delete the user account and expire all their uploaded files. This action cannot be undone.
                    </p>
                </div>
                <div class="flex flex-row-reverse p-6 space-x-2 border-t border-gray-200 rounded-b">
                    <form method="post" action="{% url 'shifter_auth:user-delete' pk=object.pk %}">
                        {% csrf_token %}
                        <input type="submit" value="Delete User" class="inline-flex justify-center m-2 text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 font-medium rounded-lg text-sm px-5 py-2.5 text-center cursor-pointer">
                    </form>
                    <button data-modal-toggle="delete-user-modal" type="button" class="inline-flex justify-center m-2 text-gray-900 bg-gray-200 hover:bg-gray-300 focus:ring-4 focus:outline-none focus:ring-primary rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 cursor-pointer">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
